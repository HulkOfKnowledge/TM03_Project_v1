/**
 * API Route: POST /api/quiz/results
 * Saves quiz results for a user
 */

import { NextRequest, NextResponse } from 'next/server';
import { createClient } from '@/lib/supabase/server';
import { createSuccessResponse, createErrorResponse } from '@/types/api.types';
import type { SaveQuizResultsRequest, SaveQuizResultsResponse } from '@/types/quiz.types';
import { addQuizAttempt, getQuizAttemptsByLesson, getNextAttemptNumber, getBestQuizScore, type QuizAttemptRecord } from '@/lib/api/quiz-storage';

export async function POST(request: NextRequest) {
  try {
    const body: SaveQuizResultsRequest = await request.json();

    console.log('[Quiz Results API] Received request:', {
      lessonId: body.lessonId,
      score: body.score,
      correctAnswers: body.correctAnswers,
      totalQuestions: body.totalQuestions,
    });

    // Validate required fields
    if (!body.lessonId || body.score === undefined || !body.answers) {
      console.error('[Quiz Results API] Validation error: Missing required fields');
      return NextResponse.json(
        createErrorResponse('VALIDATION_ERROR', 'Missing required fields'),
        { status: 400 }
      );
    }

    // Get authenticated user
    const supabase = await createClient();
    const { data: { user }, error: authError } = await supabase.auth.getUser();

    console.log('[Quiz Results API] Auth check:', {
      hasUser: !!user,
      userId: user?.id,
      authError: authError?.message,
    });

    if (authError || !user) {
      console.error('[Quiz Results API] Authentication failed:', authError);
      return NextResponse.json(
        createErrorResponse('UNAUTHORIZED', 'User not authenticated'),
        { status: 401 }
      );
    }

    const userId = user.id;

    // Get next attempt number for this user/lesson
    console.log('[Quiz Results API] Getting next attempt number...');
    const attemptNumber = await getNextAttemptNumber(body.lessonId, userId);
    console.log('[Quiz Results API] Next attempt number:', attemptNumber);

    // Get best score before this attempt
    const previousBestScore = await getBestQuizScore(body.lessonId, userId);
    const newBestScore = body.score > previousBestScore;

    // Create quiz result record (id will be generated by database)
    const quizResult: QuizAttemptRecord = {
      id: '', // Will be populated by database
      userId,
      lessonId: body.lessonId,
      score: body.score,
      correctAnswers: body.correctAnswers,
      totalQuestions: body.totalQuestions,
      answers: body.answers,
      timeSpent: body.timeSpent || 0,
      completedAt: new Date(body.completedAt),
      attemptNumber,
      createdAt: new Date(),
    };

    console.log('[Quiz Results API] Attempting to save quiz result:', {
      attemptNumber: quizResult.attemptNumber,
      lessonId: body.lessonId,
    });

    // Store the result in database (id will be generated and returned)
    const savedResult = await addQuizAttempt(quizResult);
    
    console.log(`[Quiz Results API] Successfully saved quiz result for lesson ${savedResult.lessonId}, ID: ${savedResult.id}`);

    // Check if user earned a certificate (score >= 80%)
    const certificateEarned = body.score >= 80;

    const response: SaveQuizResultsResponse = {
      success: true,
      data: {
        quizResultId: savedResult.id,
        newBestScore,
        certificateEarned,
      },
    };

    return NextResponse.json(createSuccessResponse(response.data!), { status: 201 });
  } catch (error) {
    console.error('[Quiz Results API] Error saving quiz results:', error);
    console.error('[Quiz Results API] Error details:', {
      message: error instanceof Error ? error.message : 'Unknown error',
      stack: error instanceof Error ? error.stack : undefined,
    });
    return NextResponse.json(
      createErrorResponse('SERVER_ERROR', 'Failed to save quiz results'),
      { status: 500 }
    );
  }
}
